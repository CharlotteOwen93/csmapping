---
output: 
  govdown::govdown_document:
    font: "sans-serif"
    favicon: "none"
    logo: "icon.svg"
    logo_url: "https://mattkerlogue.github.io/csmapping"
    logo_text: ""
    page_title: "UK Civil Servants by local authority (2018)"
    title: "Mapping civil servants"
    phase: alpha
    feedback_url: "https://mattkerlogue.github.io/csmapping/issues"
    
---

```{r setup, include=FALSE}

library(tidyverse)
library(geojsonio)
library(sp)
library(leaflet)
library(DT)
library(knitr)
library(kableExtra)

cs18_lad <- read_csv("https://www.nomisweb.co.uk/api/v01/dataset/NM_129_1.data.csv?geography=1820327937...1820328307&date=latest&department=0&national_identity=0&gender=0&full_part_time=0&ethnic_group=0&disability_status=0&wage_band=0&civil_service_grade=0&age_band=0&measures=20100")

spdf_lad <- geojson_read("https://opendata.arcgis.com/datasets/bbb0e58b0be64cc1a1460aa69e33678f_0.geojson", what = "sp")

lad_dt <- cs18_lad %>%
  select(geo_id = GEOGRAPHY_CODE, name = GEOGRAPHY_NAME, value = OBS_VALUE) %>%
  mutate(pc = formattable::percent(
    value/430080),
    value = formattable::comma(value))

lad_leaf <- sp::merge(spdf_lad, lad_dt, by.x = "lad19cd", by.y = "geo_id")

bincol <- colorBin("Purples",
                   lad_dt$value,
                   bins = c(0, 500, 1000, 2500, 5000, 7000, 40000, 50000),
                   pretty = FALSE,
                   na.color = NA)

```

# UK Civil Servants by local authority (2018)

::: {.lead-para}
This page provides details of UK civil servants in England, Scotland and Wales by local authority (district and unitary authorities) as at 31 March 2018.
:::

Data is available for 369 local authorities in England, Scotland and Wales, data for UK civil servants in Northern Ireland is not avilable. Figures are rounded to the nearest 10.

```{r map, echo=FALSE}

leaflet(lad_leaf, width = "100%", height = 500) %>%
  addProviderTiles(providers$CartoDB.PositronNoLabels) %>%
  addMapPane("dt", zIndex = 410) %>%
  addMapPane("labs", zIndex = 420) %>%
  addPolygons(color = "#ffffff",
              weight = 2,
              fillColor = ~bincol(value),
              popup = ~paste(name, value, sep = ": "),
              fillOpacity = 0.8,
              options = pathOptions(pane = "dt")) %>%
  addProviderTiles(providers$CartoDB.PositronOnlyLabels, 
                   options = providerTileOptions(pane = "labs")) %>%
  addLegend(position = "bottomleft", pal = bincol, values = ~lad_dt$value, 
            title = "Number of civil servants", opacity = 0.8)

```

The table below shows the data for all local authorities in the map, in addition to the number of civil servants it also shows this number as a percentage of all UK Civil Servants. There are a further 3,540 UK civil servants working in Northern Ireland, and a further 7,440 who work overseas or whose working location is not known.

```{r table, echo=FALSE}

lad_dt2 <- lad_dt %>%
  select(name, value, pc) %>%
  arrange(desc(value))

datatable(lad_dt2,
          colnames = c("Local authority" = "name",
                       "Number" = "value",
                       "Percent of Total" = "pc"),
          options =
            list(pageLength = 15,
                 initComplete = JS("function(settings, json) {",
                                   "$('.datatables').css({'font-family': 'sans-serif'});",
                                   "}"))) %>%
  formatRound("Number", digits = 0) %>%
  formatPercentage("Percent of Total", 1)

```

---

### About
UK civil servants are those civil servants working either for organisations of the UK Government, the Scottish Government or the Welsh Government. Most civil servants in Northern Ireland work for the Northern Irish Civil Service, which is a separate legal civil service.

The data for this map and table comes from the ONS' Annual Civil Service Employment Survey 2018, provided via the [NOMIS API](https://www.nomisweb.co.uk/), the geographic shape files are from the ONS's [OpenGeography Portal](http://geoportal.statistics.gov.uk). This document is produced in [RMarkdown](http://rmarkdown.rstudio.com) using [`leaflet`](https://rstudio.github.io/leaflet/) and [`DT`](https://rstudio.github.io/DT/); it has been rendered into HTML using [`govdown`](https://ukgovdatascience.github.io/govdown/).
